<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Import Project="GitHash.props" />

  <Target Name="GenerateAssemblyLevelAttributes"
          BeforeTargets="CoreCompile">

    <PropertyGroup>
      <GeneratedFSharpAssemblyLevelAttributesFile>$(IntermediateOutputPath)$(MSBuildProjectName).AssemblyLevelAttributes$(DefaultLanguageSourceExtension)</GeneratedFSharpAssemblyLevelAttributesFile>
    </PropertyGroup>

    <WriteCodeFragment AssemblyAttributes="@(AssemblyLevelAttribute)"
                       Language="$(Language)"
                       OutputFile="$(GeneratedFSharpAssemblyLevelAttributesFile)"
                       Condition="'@(AssemblyLevelAttribute)' != ''">
      <Output TaskParameter="OutputFile" ItemName="Compile" Condition="'$(Language)' != 'F#'" />
      <Output TaskParameter="OutputFile" ItemName="CompileBefore" Condition="'$(Language)' == 'F#'" />
      <Output TaskParameter="OutputFile" ItemName="FileWrites" />
    </WriteCodeFragment>

  </Target>

  <Target Name="GenerateAssemblyFileVersion"
          BeforeTargets="CoreCompile"
          Condition="'$(Configuration)' != 'Proto'">

    <PropertyGroup>
      <GeneratedFSharpAssemblyVersionFile>$(IntermediateOutputPath)$(MSBuildProjectName).AssemblyVersion$(DefaultLanguageSourceExtension)</GeneratedFSharpAssemblyVersionFile>
    </PropertyGroup>

    <PropertyGroup>
      <!-- xbuild and older versions of msbuild don't have F# support for WriteCodeFragment -->
      <_UseWriteCodeFragmentHack Condition="'$(OS)' == 'Unix' and '$(Language)' == 'F#'">true</_UseWriteCodeFragmentHack>
    </PropertyGroup>

    <ItemGroup Condition="'$(_UseWriteCodeFragmentHack)' != 'true'">
      <_AssemblyVersionAttributes Include="System.Reflection.AssemblyCompanyAttribute">
        <_Parameter1>Microsoft Corporation</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="System.Reflection.AssemblyCopyrightAttribute">
        <_Parameter1>&#169; Microsoft Corporation.  All Rights Reserved.</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="System.Reflection.AssemblyDescriptionAttribute">
        <_Parameter1>$(AssemblyName)</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="System.Reflection.AssemblyFileVersionAttribute">
        <_Parameter1>$(Build_FileVersion)</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="System.Reflection.AssemblyInformationalVersionAttribute">
        <_Parameter1>$(MicroBuildAssemblyVersion).  Commit Hash: $(GitHeadSha).</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="System.Reflection.AssemblyProductAttribute">
        <_Parameter1>Microsoft&#174; F#</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="System.Reflection.AssemblyTitleAttribute">
        <_Parameter1>$(AssemblyName)</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="System.Reflection.AssemblyVersionAttribute">
        <_Parameter1>$(MicroBuildAssemblyVersion)</_Parameter1>
      </_AssemblyVersionAttributes>
    </ItemGroup>

    <ItemGroup Condition="'$(_UseWriteCodeFragmentHack)' == 'true'">
      <_AssemblyVersionAttributes Include="Microsoft Corporation">
        <_Parameter1>System.Reflection.AssemblyCompanyAttribute</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="&#169; Microsoft Corporation.  All Rights Reserved.">
        <_Parameter1>System.Reflection.AssemblyCopyrightAttribute</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="$(AssemblyName)">
        <_Parameter1>System.Reflection.AssemblyDescriptionAttribute</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="$(Build_FileVersion)">
        <_Parameter1>System.Reflection.AssemblyFileVersionAttribute</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="$(MicroBuildAssemblyVersion).  Commit Hash: $(GitHeadSha).">
        <_Parameter1>System.Reflection.AssemblyInformationalVersionAttribute</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="Microsoft&#174; F#">
        <_Parameter1>System.Reflection.AssemblyProductAttribute</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="$(AssemblyName)">
        <_Parameter1>System.Reflection.AssemblyTitleAttribute</_Parameter1>
      </_AssemblyVersionAttributes>
      <_AssemblyVersionAttributes Include="$(MicroBuildAssemblyVersion)">
        <_Parameter1>System.Reflection.AssemblyVersionAttribute</_Parameter1>
      </_AssemblyVersionAttributes>
    </ItemGroup>

    <WriteCodeFragment AssemblyAttributes="@(_AssemblyVersionAttributes)"
                       Language="$(Language)"
                       OutputFile="$(GeneratedFSharpAssemblyVersionFile)"
                       Condition="'$(_UseWriteCodeFragmentHack)' != 'true'">
      <!-- For FSharp.Core, assembly version must be inserted after all Core files, as it defines F# basic types (strings) -->
      <Output TaskParameter="OutputFile" ItemName="Compile" Condition="'$(Language)' != 'F#' or '$(AssemblyName)' == 'FSharp.Core'" />
      <!-- For other assemblies, this must be inserted before all source files, to keep exe's EntryPoints (if any) as the last source file -->
      <Output TaskParameter="OutputFile" ItemName="CompileBefore" Condition="'$(Language)' == 'F#' and '$(AssemblyName)' != 'FSharp.Core'" />
      <Output TaskParameter="OutputFile" ItemName="FileWrites" />
    </WriteCodeFragment>

    <ItemGroup Condition="'$(_UseWriteCodeFragmentHack)' == 'true'">
      <_LinesToWrite Include="namespace FSharp" />
      <_LinesToWrite Include="open System" />
      <_LinesToWrite Include="open System.Reflection" />
      <_LinesToWrite Include="[&lt;assembly: %(_AssemblyVersionAttributes._Parameter1)(&quot;%(_AssemblyVersionAttributes.Identity)&quot;)&gt;]" />
      <_LinesToWrite Include="do()" />

      <Compile Include="$(GeneratedFSharpAssemblyVersionFile)" Condition="'$(Language)' != 'F#' or '$(AssemblyName)' == 'FSharp.Core'" />
      <CompileBefore Include="$(GeneratedFSharpAssemblyVersionFile)" Condition="'$(Language)' == 'F#' and '$(AssemblyName)' != 'FSharp.Core'" />
      <FileWrites Include="$(GeneratedFSharpAssemblyVersionFile)" />
    </ItemGroup>

    <WriteLinesToFile File="$(GeneratedFSharpAssemblyVersionFile)"
                      Lines="@(_LinesToWrite)"
                      Overwrite="true"
                      Condition="'$(_UseWriteCodeFragmentHack)' == 'true' and !Exists('$(GeneratedFSharpAssemblyVersionFile)')" />
  </Target>

</Project>
